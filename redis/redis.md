# 第九章：数据库

## 过期键删除策略

1. 定时删除: 在设置键过期时间的同时，创建定时器，让定时器在键过期时间来临时， 立即执行对键的删除操作

   > 优点 :对内存是最友好的 -> 使用定时器能保证过期键能尽快删除
   >
   > 缺点: 对CPU时间不优化 -> 当过期键较多，删除过期键可能会占用相当一部分的CPU时间， 会对服务器的响应时间和吞吐量造成影响

2. 惰性删除: 每次从键空间中获取键的时候，检查取得的键是否过期，如果过期就删除这个键，没有过期就返回

   > 优点: 对CPU时间最友好 -> 取出键时对键进行过期检查，保证删除过期键的操作只会在非做不可的情况下进行
   >
   > 缺点: 对内存不友好， 在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么它们也许永远也不会被删除

3. 定期删除: 每隔一段时间，程序就对数据库进行检查，删除过期键(以上两种的折中方法)

   > 通过限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响
   >
   > 有效地减少因为过期键带来的内存消费

 

# AOF、RDB和复制功能对过期键的处理

## 生成RDB文件

> 执行<kbd>SAVE</kbd>或者<kbd>BGSAVE</kbd>创建一个新的RDB文件， 会对数据库中的键进行检查， 已经过期的键不会被保存先创建的RDB文件中

因此， 数据库中包含过期键不会对新生成的RDB文件造成影响

## 载入RDB文件

如果服务器开启了RDB功能，那么服务器将对RDB文件进行载入

> 主服务器模式：对保存的键进行检查，未过期的载入到DB，过期则会忽略
>
> 从服务器模式：无论是否过期都会载入到DB，因此过期键对载入RDB文件的从服务器不会造成影响。

# AOF文件写入/重写

写入：以AOF持久化模式运行时，某个键已经过期但是没有被惰性删除或者定期删除，那么AOF文件不会因为这个过期键而产生影响。

重写：过期键不会对AOF重写造成影响

> 如果使用GET message命令，试图访问过期的message键，将执行三个动作
>
> 1. 从数据库中删除message键
> 2. 追加一条DEL message命令到AOF文件
> 3. 向执行GET命令的客户端返回空回复