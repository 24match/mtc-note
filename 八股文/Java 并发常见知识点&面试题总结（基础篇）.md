# Java并发常见知识点

## 什么是线程和进程?

### 进程

进程是程序的一次执行过程，是系统运行程序的基本单位，因此进程是动态的。系统运行一个程序即是一个进程从创建，运行到消亡的过程。

eg：启动main函数就是启动了一个JVM进程，main函数所在的线程就是这个进程中的一个线程也就是主线程。

### 线程

线程是比进程更小的执行单位。一个进程在执行过程中可以产生多个线程。与进程不同的时同类的多个线程共享进程的<b>堆</b>和<b>方法区</b>资源，但每个线程都有自己的程序计数器、虚拟机栈和本地方法栈，所以系统在产生一个线程，或是在各个线程之间作切换工作时，负担要比进程小得多，也正因为如此，线程也被称为轻量级进程。

```java
public class MultiThread {
	public static void main(String[] args) {
		// 获取 Java 线程管理 MXBean
		ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
		// 不需要获取同步的 monitor 和 synchronizer 信息，仅获取线程和线程堆栈信息
		ThreadInfo[] threadInfos = threadMXBean.dumpAllThreads(false, false);
		// 遍历线程信息，仅打印线程 ID 和线程名称信息
		for (ThreadInfo threadInfo : threadInfos) {
			System.out.println("[" + threadInfo.getThreadId() + "] " + threadInfo.getThreadName());
		}
	}
}
```

输出：

```console
[5] Attach Listener 	//添加事件
[4] Signal Dispatcher 	//分发处理给 JVM 信号的线程
[3] Finalizer 			//调用对象 finalize 方法的线程
[2] Reference Handler 	//清除 reference 线程
[1] main 				//main 线程,程序入口
```

**一个 Java 程序的运行是 main 线程和多个其他线程同时运行**

一个进程可以有多个线程，多个线程共享进程的堆和方法区（JDK1.8之后的元空间）资源，但是每个线程有自己的程序计数器、虚拟器栈和本地方法栈。

总结：**线程是进程划分成的更小的运行单位。线程和进程最大的不同在于基本上各进程是独立的，而各线程则不一定，因为同一进程中的线程极有可能会相互影响。线程执行开销小，但不利于资源的管理和保护；而进程正相反。**

### 拓展

#### 为什么程序计数器是私有的？

1. 字节码解释器通过改变程序计数器来依次读取指令，从而实现代码的流程控制，如顺序执行、选择、循环、异常处理。
2. 在多线程的情况下，程序计数器用于记录当前线程执行的位置，从而当线程被切换回来的时候能知道该线程上次运行的位置。

> 需要注意的是，如果执行的是 native 方法，那么程序计数器记录的是 undefined 地址，只有执行的是 Java 代码时程序计数器记录的才是下一条指令的地址。
>
> 程序计数器私有主要是为了**线程切换后能恢复到正确的执行位置**

#### 虚拟机栈和本地方法栈为什么是私有的？

+ 虚拟机栈：每个Java方法在执行时会同时创建一个栈帧用于存储局部变量表、操作数栈、常量池引用等信息。从方法调用直至执行完成的过程，就对应着一个栈帧在Java虚拟机栈中入栈和出栈的过程。
+ 本地方法栈：和虚拟机栈的作用相似。区别：虚拟机栈为字节码服务，而本地方法栈则为虚拟机使用到的Native方法服务。在HotSpot虚拟机中和Java虚拟机栈合二为一。

#### 简单了解堆和方法区

堆和方法去是所有线程共享的资源，

堆是进程中最大的一块内存，主要存放新创建的对象（几乎所有对象都在这里分配内存），

方法区主要用于存放已被加载的类信息、常量、静态变量、即时编译后的代码等数据。

#### 并发与并行的区别？

+ 并发：同一时间段，多个任务都在执行；
+ 并行：单位时间内，多个任务同时执行。

#### 为什么要使用多线程？

+ 从计算机底层角度出发：线程可以比作是轻量级的进程，程序执行的最小单元，线程间切换和调度的成本远低于进程。多核CPU的时代意味着多个线程可以同时运行，减少了线程上下文切换的开销。
+ 从互联网角度出发：多线程是高并发系统的基础，利用好多线程可以提高系统的整体并发能力。

计算机底层：

> 单核时代：为了提高单进程利用CPU和IO系统的效率。
>
> 多核时代：多核时代多线程主要是为了提高进程利用多核CPU的能力。

#### 使用多线程会造成什么问题？

并发编程的目的就是为了能提高程序的执行效率提高程序运行速度，但是并发编程并不总是能提高程序运行速度的，而且并发编程可能会遇到很多问题，比如：内存泄漏、死锁、线程不安全等等。

#### 线程的生命周期和状态

| 状态名称     | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| NEW          | 初始状态，线程被构建，但是还没有调用start()方法              |
| RUNNABLE     | 运行状态，Java线程将操作系统中的就绪和运行两种状态笼统地称作“运行中” |
| BLOCKED      | 阻塞状态，表示线程阻塞于锁                                   |
| WAITING      | 等待状态，表示线程进入等待状态，进入该状态表示当前线程需要等待其他线程做出一些特定动作 |
| TIME_WAITING | 超时等待状态，该状态不同于WAITING，它是可以在指定时间自行返回的 |
| TERMINATED   | 终止状态，表示当前线程已经执行完毕                           |





